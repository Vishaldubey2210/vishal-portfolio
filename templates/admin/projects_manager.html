{% extends 'admin/base.html' %}

{% block title %}Manage Projects - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-folder-open me-2"></i>Manage Projects</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projectModal">
            <i class="fas fa-plus me-2"></i>Add New Project
        </button>
    </div>
    
    <div id="message"></div>
    
    <div class="row g-4" id="projects-container">
        <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Loading projects...</p>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder-plus me-2"></i>Add New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="project-form">
                    <div class="mb-3">
                        <label for="project-title" class="form-label">Project Title *</label>
                        <input type="text" class="form-control" id="project-title" placeholder="Enter project title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-description" class="form-label">Description *</label>
                        <textarea class="form-control" id="project-description" rows="3" placeholder="Describe your project" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-category" class="form-label">Category *</label>
                        <select class="form-select" id="project-category" required>
                            <option value="">Select Category</option>
                            <option value="data-science">Data Science</option>
                            <option value="machine-learning">Machine Learning</option>
                            <option value="computer-vision">Computer Vision</option>
                            <option value="full-stack">Full Stack</option>
                            <option value="web-development">Web Development</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-tags" class="form-label">Tags (comma separated) *</label>
                        <input type="text" class="form-control" id="project-tags" placeholder="Python, Flask, MongoDB" required>
                        <small class="text-muted">Separate tags with commas</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-github" class="form-label">GitHub URL (Optional)</label>
                        <input type="url" class="form-control" id="project-github" placeholder="https://github.com/username/repo">
                        <small class="text-muted">Link to your GitHub repository</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-demo" class="form-label">Live Demo URL (Optional)</label>
                        <input type="url" class="form-control" id="project-demo" placeholder="https://example.com">
                        <small class="text-muted">Add the live working link of your project</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="project-image" class="form-label">Image URL (Optional)</label>
                        <input type="url" class="form-control" id="project-image" placeholder="/static/images/project.jpg">
                        <small class="text-muted">Project thumbnail image URL</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()">
                    <i class="fas fa-save me-2"></i>Save Project
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function loadProjects() {
    try {
        const response = await fetch('/api/admin/projects');
        const data = await response.json();
        
        if (data.success && data.projects.length > 0) {
            displayProjects(data.projects);
        } else {
            document.getElementById('projects-container').innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                    <p class="text-muted">No projects yet. Add your first project!</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Failed to load projects');
    }
}

function displayProjects(projects) {
    const container = document.getElementById('projects-container');
    
    container.innerHTML = projects.map(project => `
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
                <img src="${project.image}" class="card-img-top" alt="${project.title}" style="height: 200px; object-fit: cover;" onerror="this.src='/static/images/default-project.jpg'">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary">${project.category}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProject(${project.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <h5 class="card-title">${project.title}</h5>
                    <p class="card-text text-muted small">${project.description.substring(0, 100)}...</p>
                    
                    <div class="mb-2">
                        ${project.tags.slice(0, 3).map(tag => `<span class="badge bg-light text-dark">${tag}</span>`).join(' ')}
                    </div>
                    
                    <div class="d-flex gap-2 flex-wrap">
                        ${project.github ? `
                            <a href="${project.github}" target="_blank" class="btn btn-sm btn-outline-secondary" title="View Code">
                                <i class="fab fa-github"></i>
                            </a>
                        ` : ''}
                        ${project.demo ? `
                            <a href="${project.demo}" target="_blank" class="btn btn-sm btn-outline-primary" title="Live Demo">
                                <i class="fas fa-external-link-alt"></i> Demo
                            </a>
                        ` : ''}
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Added recently
                    </small>
                </div>
            </div>
        </div>
    `).join('');
}

async function saveProject() {
    const title = document.getElementById('project-title').value.trim();
    const description = document.getElementById('project-description').value.trim();
    const category = document.getElementById('project-category').value;
    const tagsInput = document.getElementById('project-tags').value.trim();
    const github = document.getElementById('project-github').value.trim();
    const demo = document.getElementById('project-demo').value.trim();
    const image = document.getElementById('project-image').value.trim();
    
    if (!title || !description || !category || !tagsInput) {
        showMessage('error', 'Please fill all required fields');
        return;
    }
    
    const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
    
    const projectData = {
        title,
        description,
        category,
        tags,
        github: github || null,
        demo: demo || null,
        image: image || '/static/images/default-project.jpg'
    };
    
    try {
        const response = await fetch('/api/admin/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
            document.getElementById('project-form').reset();
            loadProjects();
        } else {
            showMessage('error', result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Failed to save project');
    }
}

async function deleteProject(id) {
    if (!confirm('Are you sure you want to delete this project?')) return;
    
    try {
        const response = await fetch(`/api/admin/projects?id=${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('success', result.message);
            loadProjects();
        } else {
            showMessage('error', result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('error', 'Failed to delete project');
    }
}

function showMessage(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    document.getElementById('message').innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show">
            <i class="fas ${icon} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    setTimeout(() => {
        document.getElementById('message').innerHTML = '';
    }, 5000);
}

// Load projects on page load
loadProjects();
</script>
{% endblock %}
