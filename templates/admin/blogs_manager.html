{% extends 'base.html' %}

{% block title %}Manage Blogs | Admin{% endblock %}

{% block content %}
<section class="py-5 mt-5">
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 mb-4">
                <div class="glass-effect p-3 rounded">
                    <h5 class="text-white mb-4">Dashboard</h5>
                    <nav class="nav flex-column">
                        <a class="nav-link text-muted" href="/admin/dashboard">
                            <i class="fas fa-chart-line me-2"></i>Overview
                        </a>
                        <a class="nav-link text-muted" href="/admin/projects">
                            <i class="fas fa-folder me-2"></i>Projects
                        </a>
                        <a class="nav-link text-white active" href="/admin/blogs">
                            <i class="fas fa-blog me-2"></i>Blogs
                        </a>
                        <a class="nav-link text-muted" href="/admin/certifications">
                            <i class="fas fa-certificate me-2"></i>Certifications
                        </a>
                        <a class="nav-link text-muted" href="/admin/analytics">
                            <i class="fas fa-chart-bar me-2"></i>Analytics
                        </a>
                        <hr style="border-color: rgba(255,255,255,0.1);">
                        <a class="nav-link text-danger" href="/admin/logout">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="gradient-text">Manage Blog Posts</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBlogModal">
                        <i class="fas fa-plus me-2"></i>Write New Post
                    </button>
                </div>

                <!-- Blogs List -->
                <div id="blogs-list" class="row g-4">
                    <div class="col-12 text-center">
                        <div class="loading"></div>
                        <p class="text-muted mt-3">Loading blog posts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Blog Modal -->
<div class="modal fade" id="addBlogModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(34, 211, 238, 0.3);">
            <div class="modal-header border-0">
                <h5 class="modal-title gradient-text">Write New Blog Post</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-blog-form">
                    <div class="mb-3">
                        <label class="form-label text-white">Blog Title *</label>
                        <input type="text" name="title" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" required placeholder="Enter blog title">
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white">Slug (URL friendly)</label>
                        <input type="text" name="slug" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" placeholder="auto-generated-from-title">
                        <small class="text-muted">Leave blank to auto-generate from title</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white">Excerpt (Short Description) *</label>
                        <textarea name="excerpt" rows="2" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" required placeholder="Brief description of your blog post"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white">Content *</label>
                        <textarea name="content" rows="10" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" required placeholder="Write your blog content here..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white">Tags (comma separated) *</label>
                        <input type="text" name="tags" class="form-control" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white;" placeholder="Python, Machine Learning, AI" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane me-2"></i>Publish Blog Post
                    </button>

                    <div id="blog-message" class="mt-3"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let allBlogs = [];

    // Load blogs
    async function loadBlogs() {
        try {
            const response = await fetch('/api/admin/blogs');
            const data = await response.json();
            allBlogs = data.blogs;
            displayBlogs(allBlogs);
        } catch (error) {
            console.error('Error loading blogs:', error);
        }
    }

    // Display blogs
    function displayBlogs(blogs) {
        const container = document.getElementById('blogs-list');
        
        if (blogs.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center">
                    <div class="glass-effect p-5">
                        <i class="fas fa-blog fa-4x text-primary mb-3"></i>
                        <h4 class="text-white">No Blog Posts Yet</h4>
                        <p class="text-muted">Click "Write New Post" to create your first blog!</p>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = blogs.map(blog => `
            <div class="col-md-6 col-lg-4">
                <div class="glass-effect p-4 h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="text-white mb-0">${blog.title}</h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBlog(${blog.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <p class="text-muted small mb-3">${blog.excerpt}</p>
                    <div class="d-flex flex-wrap gap-1 mb-3">
                        ${blog.tags.slice(0, 3).map(tag => `<span class="badge-custom">${tag}</span>`).join('')}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            ${new Date(blog.publishedAt).toLocaleDateString()}
                        </small>
                        <a href="/blog/${blog.slug}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>View
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Add blog form
    document.getElementById('add-blog-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const messageDiv = document.getElementById('blog-message');
        
        const blogData = {
            title: formData.get('title'),
            slug: formData.get('slug') || null,
            excerpt: formData.get('excerpt'),
            content: formData.get('content'),
            tags: formData.get('tags').split(',').map(t => t.trim())
        };
        
        messageDiv.innerHTML = '<div class="alert alert-info">Publishing blog post...</div>';
        
        try {
            const response = await fetch('/api/admin/blogs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(blogData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                messageDiv.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                e.target.reset();
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('addBlogModal')).hide();
                    loadBlogs();
                }, 2000);
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        } catch (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Failed to publish blog post</div>`;
        }
    });

    // Delete blog
    async function deleteBlog(id) {
        if (confirm('Are you sure you want to delete this blog post?')) {
            try {
                const response = await fetch(`/api/admin/blogs?id=${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    loadBlogs();
                }
            } catch (error) {
                alert('Failed to delete blog post');
            }
        }
    }

    loadBlogs();
</script>

<style>
.form-control:focus {
    background: rgba(255,255,255,0.08) !important;
    border-color: #22D3EE !important;
    color: white !important;
}
</style>
{% endblock %}
